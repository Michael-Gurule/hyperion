# =============================================================================
# HYPERION Docker Compose Configuration
# Orchestrates all services for the Multi-Agent RL system
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # Dashboard Service - Streamlit visualization
  # ---------------------------------------------------------------------------
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hyperion-dashboard
    ports:
      - "8501:8501"
    volumes:
      # Mount outputs for live evaluation results
      - ./outputs:/app/outputs:ro
      # Mount checkpoints for model inspection
      - ./checkpoints:/app/checkpoints:ro
    environment:
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # Training Service - Run model training
  # ---------------------------------------------------------------------------
  training:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hyperion-training
    volumes:
      # Mount checkpoints for saving trained models
      - ./checkpoints:/app/checkpoints
      # Mount logs for training output
      - ./logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
    command: >
      python -m src.training.train_enhanced
      --timesteps 1000000
      --checkpoint-dir /app/checkpoints/docker_run
    profiles:
      - training
    deploy:
      resources:
        limits:
          memory: 8G

  # ---------------------------------------------------------------------------
  # Evaluation Service - Run model evaluation
  # ---------------------------------------------------------------------------
  evaluation:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hyperion-evaluation
    volumes:
      - ./checkpoints:/app/checkpoints:ro
      - ./outputs:/app/outputs
    command: >
      python -m src.evaluation.evaluate_checkpoint
      --checkpoint /app/checkpoints/enhanced_run2/enhanced_best.pt
      --num-episodes 100
      --output /app/outputs/docker_eval.json
    profiles:
      - evaluation

  # ---------------------------------------------------------------------------
  # TensorBoard Service - Training visualization
  # ---------------------------------------------------------------------------
  tensorboard:
    image: tensorflow/tensorflow:latest
    container_name: hyperion-tensorboard
    ports:
      - "6006:6006"
    volumes:
      - ./logs:/logs:ro
    command: tensorboard --logdir=/logs --host=0.0.0.0
    profiles:
      - monitoring

# =============================================================================
# Volume definitions for persistent data
# =============================================================================
volumes:
  checkpoints:
  outputs:
  logs:
